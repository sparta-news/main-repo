<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>News</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <style>
    * {
      margin: 0px;
      padding: 0px;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: white;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .home_button {
      background: none;
      border: none;
      color: #00C73C;
      cursor: pointer;
    }

    header {
      margin-top: 5%;
      margin-bottom: 3%;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #search {
      width: 60%;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      margin-bottom: 2%;
    }

    #search>div>button {
      width: 50px;
      border: none;
      background-color: transparent;
      cursor: pointer;
    }



    nav {
      margin-left: auto;
      margin-right: auto;
      width: 60%;
      height: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      border-bottom: 1px solid #30303860;
      padding-bottom: 10px;
    }

    nav>ul {
      list-style: none;
      display: flex;
      flex-direction: row;
      justify-content: space-evenly;
    }

    .category {
      width: 10%;
      text-align: center;
      font-weight: bold;
      color: #303038;
      background-color: white;
      border: none;
    }

    .category:hover {
      transform: translateY(-10px);
      transition: all 0.3s ease-in-out;
    }

    .add_btn {
      text-align: center;
      font-weight: bold;
      color: #303038;
      background-color: white;
      border: none;
    }

    .content-container {
      width: 100%;
      background-color: aqua;
      display: flex;
      justify-content: center;
    }

    .left-space {
      width: 20%;
      background-color: white;
    }

    .right-space {
      width: 20%;
      background-color: white;
    }

    main {
      width: 40%;
      background-color: white;
      padding: 20px;
      border-right: 1px solid rgb(219, 219, 219);
    }

    #contents {
      white-space: pre-line;
    }

    aside {
      width: 20%;
      background-color: white;
      padding: 15px;
    }

    aside ul {
      list-style: none;
      padding: 0;
    }

    aside li {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }

    aside img {
      width: 50px;
      height: 50px;
      margin-right: 10px;
    }

    .rating {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .rating button {
      border: 2px solid #00C73C;
      background-color: transparent;
      padding: 10px;
      cursor: pointer;
      font-size: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 199, 60, 0.3);
      transition: all 0.3s ease;
    }

    .rating button:hover {
      background-color: rgba(0, 199, 60, 0.1);
      box-shadow: 0 6px 8px rgba(0, 199, 60, 0.5); 
    }


    a {
      color: black;
      text-decoration: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    a:hover {
      color: #00C73C;
    }

    .add_btn:hover {
      color: #00C73C;
    }
  </style>
  <script type="module">



    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy, limit, Timestamp, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // Firebase êµ¬ì„± ì •ë³´
    const firebaseConfig = {
      apiKey: "AIzaSyBnZSX3atvHqAKvrMn_c-oGsgEvYfJw33s",
      authDomain: "sparta-6c3c1.firebaseapp.com",
      projectId: "sparta-6c3c1",
      storageBucket: "sparta-6c3c1.firebasestorage.app",
      messagingSenderId: "392838436875",
      appId: "1:392838436875:web:25daf2e154d7a714e74f0e",
      measurementId: "G-WTNBYF46GN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };


    // docid: ë¶ˆëŸ¬ì˜¤ê³ ì í•˜ëŠ” ê¸°ì‚¬ì˜ ê³ ìœ ê°’
    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('id');

    // ë”ë³´ê¸° ë²„íŠ¼ ë™ì‘ìš© ë³€ìˆ˜
    let status = "ì—†ìŒ";
    let init_info = 5;
    let economy_info = 5;
    let society_info = 5;
    let life_info = 5;
    let science_info = 5;
    let world_info = 5;
    let politics_info = 5;
    let rating_arr = new Array(5);
    let rating_btn_st = Array(5).fill(false);

    // id ê°’ì— ë§ëŠ” main í™”ë©´ ë¡œë“œ
    async function getDocument() {
      const docRef = doc(db, "news", docId);
      const docSnap = await getDoc(docRef);

      //ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í• ë•Œ ì‚¬ìš©í•´ì£¼ë©´ ì¢‹ì„ ê²ƒ
      //let arr = Array(5).fill(0); 

      if (docSnap.exists()) {
        let news = docSnap.data();

        let title = news['title'];
        let reporter = news['reporter'];
        let category = news['category'];
        let contents = news['contents'];
        let date = news['date'];
        rating_arr[0] = Number(news['rating'][0]);
        rating_arr[1] = Number(news['rating'][1]);
        rating_arr[2] = Number(news['rating'][2]);
        rating_arr[3] = Number(news['rating'][3]);
        rating_arr[4] = Number(news['rating'][4]);
        let image = news['image'];

        $("#count_0").text(rating_arr[0]);
        $("#count_1").text(rating_arr[1]);
        $("#count_2").text(rating_arr[2]);
        $("#count_3").text(rating_arr[3]);
        $("#count_4").text(rating_arr[4]);

        let date_temp1 = date.seconds * 1000 + Math.floor(date.nanoseconds / 1000000);
        let date_temp2 = new Date(date_temp1);

        let formattedContents = contents.replace(/\./g, '.\n\n');
        $("#contents").text(formattedContents);
        $("#title").text(title);

        let date_html = `${new Intl.DateTimeFormat('ko-KR', options).format(date_temp2)}`
        let reporter_html = `${reporter} ê¸°ì`
        $("#date").text(date_html);
        $("#reporter").text(reporter_html);

        let image_html = `<img src="${image}" alt="ë‰´ìŠ¤ ì´ë¯¸ì§€" style="width: 60%;">`
        $("#main_image").empty();
        $("#main_image").append(image_html);

      } else {
        console.log("í•´ë‹¹ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }

    }

    //onclick ì‚¬ìš©(í‰ê°€ í•­ëª©) db ì—°ê²° í•„ìš”
    function rateNews(index) {
      if (rating_btn_st[index]) {
        rating_arr[index] -= 1;
        rating_btn_st[index] = false;
        $("#count_0").text(rating_arr[0]);
        $("#count_1").text(rating_arr[1]);
        $("#count_2").text(rating_arr[2]);
        $("#count_3").text(rating_arr[3]);
        $("#count_4").text(rating_arr[4]);
      }
      else {
        rating_arr[index] += 1;
        rating_btn_st[index] = true;
        $("#count_0").text(rating_arr[0]);
        $("#count_1").text(rating_arr[1]);
        $("#count_2").text(rating_arr[2]);
        $("#count_3").text(rating_arr[3]);
        $("#count_4").text(rating_arr[4]);
      }
    };

    //ì‚¬ì´ë“œë°” ì´ˆê¸° í™”ë©´ 
    async function getSideNews_init(num) {

      const q = query(collection(db, "news"), orderBy("date", "desc"), limit(num));
      const querySnapshot = await getDocs(q);
      $('#side_bar').empty();

      querySnapshot.forEach((doc) => {
        let data = doc.data();

        let side_html = `<li><img src="${data.image}" alt = "ë‰´ìŠ¤1" ><a href= "detail_page.html?id=${doc.id}"> ${data.title}</a></li>`;
        $('#side_bar').append(side_html);
      });
    }

    //ì‚¬ì´ë“œë°” ì¹´í…Œê³ ë¦¬ ì„ íƒ ë° ìˆ˜ëŸ‰ ì¶”ê°€
    async function getSideNews(ctgy, num) {

      const q = query(collection(db, "news"), where("category", "==", ctgy), orderBy("date", "desc"), limit(num));
      const querySnapshot = await getDocs(q);
      $('#side_bar').empty();

      querySnapshot.forEach((doc) => {
        let data = doc.data();

        let side_html = `<li><img src="${data.image}" alt = "ë‰´ìŠ¤1" ><a href= "detail_page.html?id=${doc.id}"> ${data.title}</a></li>`;
        $('#side_bar').append(side_html);
      });
    }

    //ì¹´í…Œê³ ë¦¬ ì„ íƒ
    $("#politics").click(async function () {
      status = "ì •ì¹˜"
      getSideNews(status, 5);
    })

    $("#economy").click(async function () {
      status = "ê²½ì œ"
      getSideNews(status, 5);
    })

    $("#society").click(async function () {
      status = "ì‚¬íšŒ"
      getSideNews(status, 5);
    })

    $("#life").click(async function () {
      status = "ìƒí™œ"
      getSideNews(status, 5);
    })

    $("#science").click(async function () {
      status = "ê³¼í•™"
      getSideNews(status, 5);
    })

    $("#world").click(async function () {
      status = "ì„¸ê³„"
      getSideNews(status, 5);
    })

    $("#rating_0").click(async function () {
      rateNews(0);
      console.log(rating_arr);
      const docRef = doc(db, "news", docId);
      let rating_str_arr = rating_arr.map(rating => String(rating));
      await updateDoc(docRef, { rating: rating_str_arr });
      alert("í‰ì ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
    });

    $("#rating_1").click(async function () {
      rateNews(1);
      console.log(rating_arr);
      const docRef = doc(db, "news", docId);
      let rating_str_arr = rating_arr.map(rating => String(rating));
      await updateDoc(docRef, { rating: rating_str_arr });
      alert("í‰ì ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
    });

    $("#rating_2").click(async function () {
      rateNews(2);
      console.log(rating_arr);
      const docRef = doc(db, "news", docId);
      let rating_str_arr = rating_arr.map(rating => String(rating));
      await updateDoc(docRef, { rating: rating_str_arr });
      alert("í‰ì ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
    });

    $("#rating_3").click(async function () {
      rateNews(3);
      console.log(rating_arr);
      const docRef = doc(db, "news", docId);
      let rating_str_arr = rating_arr.map(rating => String(rating));
      await updateDoc(docRef, { rating: rating_str_arr });
      alert("í‰ì ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
    });

    $("#rating_4").click(async function () {
      rateNews(4);
      console.log(rating_arr);
      const docRef = doc(db, "news", docId);
      let rating_str_arr = rating_arr.map(rating => String(rating));
      await updateDoc(docRef, { rating: rating_str_arr });
      alert("í‰ì ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
    });

    //home ë²„íŠ¼ ë§í¬ ì¶”í›„ ìˆ˜ì • í•„ìš”!
    $("#home_btn").click(async function () {
      window.location.href = "index.html";
    })

    // ë”ë³´ê¸° ë²„íŠ¼
    $("#add_info").click(async function () {
      switch (status) {
        case "ì •ì¹˜":
          politics_info += 5;
          getSideNews(status, politics_info);
          break;
        case "ê²½ì œ":
          economy_info += 5;
          getSideNews(status, economy_info);
          break;
        case "ì‚¬íšŒ":
          society_info += 5;
          getSideNews(status, society_info);
          break;
        case "ìƒí™œ":
          life_info += 5;
          getSideNews(status, life_info);
          break;
        case "ê³¼í•™":
          science_info += 5;
          getSideNews(status, science_info);
          break;
        case "ì„¸ê³„":
          world_info += 5;
          getSideNews(status, world_info);
          break;
        default:
          init_info += 5;
          getSideNews_init(init_info);
      }
    })

    // ì´ˆê¸° í™”ë©´ êµ¬ì„±
    getDocument();
    getSideNews_init(5);
  </script>
</head>

<body>

  <header>
    <div id="search">
      <h1 style="color: #00C73C;"><button class="home_button" id="home_btn">News</button></h1>
    </div>
    <nav>
      <ul>
        <button class="category" value='ì •ì¹˜' id="politics">ì •ì¹˜</button>
        <button class="category" value='ê²½ì œ' id="economy">ê²½ì œ</button>
        <button class="category" value='ì‚¬íšŒ' id="society">ì‚¬íšŒ</button>
        <button class="category" value='ìƒí™œ' id="life">ìƒí™œ</button>
        <button class="category" value='ê³¼í•™' id="science">ê³¼í•™ ê¸°ìˆ </button>
        <button class="category" value='ì„¸ê³„' id="world">ì„¸ê³„</button>
      </ul>
    </nav>
  </header>

  <div class="content-container">
    <div class="left-space"></div>
    <main>
      <h2><strong><span id='title'>ë‰´ìŠ¤ ì œëª©</span></strong></h2>
      <div>
        <p><span id='date'>ë‚ ì§œ</span></p>
        <p><span id='reporter'>ê¸°ì‚¬</span></p>
      </div>
      <div id="main_image"></div>
      <p id="contents">ë‰´ìŠ¤ ë‚´ìš©<br><br> </p>

      <!-- rating ê¸°ëŠ¥ êµ¬í˜„ í•„ìš” -->
      <div class="rating">
        <button id="rating_0"><p>ğŸ˜€ ìœ ìš©í•¨</p> <p><span id="count_0">0</span></p></button>
        <button id="rating_1"><p>ğŸ˜€ í¥ë¯¸ì§„ì§„</p> <p><span id="count_1">0</span></p></button>
        <button id="rating_2"><p>ğŸ˜€ ê³µê°ë°±ë°°</p> <p><span id="count_2">0</span></p></button>
        <button id="rating_3"><p>ğŸ˜€ ë¶„ì„íƒì›”</p> <p><span id="count_3">0</span></p></button>
        <button id="rating_4"><p>ğŸ˜€ í›„ì†ê°•ì¶”</p> <p><span id="count_4">0</span></p></button>
      </div>


    </main>
    <aside>
      <ul id='news_list'><span id="side_bar"></span></ul>
      <button id="add_info" class="add_btn">ë” ë³´ê¸°</button>
    </aside>
    <div class="right-space"></div>
  </div>
</body>

</html>